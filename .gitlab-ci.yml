stages:
  - trigger
  - deploy-other-group

# deploy apps developed by Dadura & Wlodarczyk

trigger-patient-data:
  stage: trigger
  trigger:
    include: Projekt/PatientsData/.gitlab-ci.yml
    strategy: depend
  rules:
    - changes:
        - Projekt/PatientsData/**/*
        - Miniprojekty/Kubernetes/PatientsData/**/*
         
trigger-doctors-app:
  stage: trigger
  trigger:
    include: Projekt/DoctorsApp/.gitlab-ci.yml
    strategy: depend
  rules:
    - changes:
        - Projekt/DoctorsApp/**/*
        - Miniprojekty/Kubernetes/DoctorsApp/**/*

trigger-patient-web:
  stage: trigger
  trigger:
    include: Projekt/PatientsWebApp/.gitlab-ci.yml
    strategy: depend
  rules:
    - changes:
        - Projekt/PatientsWebApp/**/*
        - Miniprojekty/Kubernetes/PatientsWebApp/**/*


# deploy apps developed by Zdulski & Walusiak
      
deploy-dd 1:2:
  stage: deploy-other-group
  tags:
    - deployment
  image:
    name: bitnami/kubectl
    entrypoint: [ "" ]
  before_script:
    - export KUBECONFIG=$(mktemp)
    - cat $K8S_CONFIG | base64 -d > ${KUBECONFIG}
    - pwd
  script:
    - kubectl apply -f Miniprojekty/Kubernetes/DoctorsData
    - kubectl rollout restart deployment pro-dd-deployment
  rules:
    - changes:
        - Projekt/DoctorsData/**/*
        - Miniprojekty/Kubernetes/DoctorsData/**/*
      
deploy-pa 2:2:
  stage: deploy-other-group
  tags:
    - deployment
  image:
    name: bitnami/kubectl
    entrypoint: [ "" ]
  before_script:
    - export KUBECONFIG=$(mktemp)
    - cat $K8S_CONFIG | base64 -d > ${KUBECONFIG}
  script:
    - kubectl apply -f Miniprojekty/Kubernetes/PatientsApp
    - kubectl rollout restart deployment pro-pa-deployment
  rules:
    - changes:
        - Projekt/PatientsApp/**/*
        - Miniprojekty/Kubernetes/PatientsApp/**/*